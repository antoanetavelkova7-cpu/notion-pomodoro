<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pomodoro Timer</title>
<style>
  :root { --bg:#0b0b0c; --fg:#f7f7f8; --muted:#a9acb3; --accent:#7c8cff; --good:#61d095; --warn:#ffb86b; }
  * { box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; }
  body { margin:0; background:var(--bg); color:var(--fg); display:grid; place-items:center; min-height:100vh; }
  .app { width:min(680px, 94vw); padding:24px; border:1px solid #1b1c20; border-radius:16px; background:#101114; box-shadow:0 8px 30px rgba(0,0,0,.35); }
  .modes { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; }
  .modes button { flex:1; min-width:120px; padding:10px 12px; border-radius:12px; border:1px solid #1e1f24; background:#14151a; color:var(--muted); cursor:pointer }
  .modes button.active { color:var(--fg); border-color:var(--accent); box-shadow:0 0 0 2px rgba(124,140,255,.25) inset; }
  .timer { text-align:center; margin:10px 0 18px }
  .time { font-size:64px; font-weight:700; letter-spacing:2px; }
  .sub { font-size:12px; color:var(--muted); margin-top:6px; }
  .controls { display:flex; gap:10px; justify-content:center; margin:16px 0 8px; flex-wrap:wrap; }
  .controls button { padding:12px 16px; border:none; border-radius:12px; cursor:pointer; font-weight:600; }
  .primary { background:var(--accent); color:#0b0b0c; }
  .ghost { background:#191a20; color:var(--fg); }
  .danger { background:#2a1a1a; color:#ff6b6b; }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; margin-top:14px; }
  label { font-size:12px; color:var(--muted); }
  input[type=number] { width:84px; padding:10px; border-radius:10px; border:1px solid #22242b; background:#14151a; color:var(--fg); }
  .stats { margin-top:14px; text-align:center; color:var(--muted); font-size:12px; }
  .ring { width:220px; height:220px; border-radius:999px; border:6px solid #1c1e26; margin:0 auto 12px; position:relative; }
  .ring::after { content:""; position:absolute; inset:0; border-radius:inherit; border:6px solid var(--accent); transform:rotate(calc(var(--p,0)*1deg)); border-left-color:transparent; border-bottom-color:transparent; border-right-color:transparent; transition:transform .3s linear; }
  @media (max-width:420px){ .time{font-size:48px} }
</style>
</head>
<body>
<div class="app">
  <div class="modes">
    <button data-mode="work" class="active">Focus</button>
    <button data-mode="short">Short Break</button>
    <button data-mode="long">Long Break</button>
  </div>

  <div class="timer">
    <div class="ring" id="ring"></div>
    <div class="time" id="time">25:00</div>
    <div class="sub" id="subtitle">Ready</div>
  </div>

  <div class="controls">
    <button class="primary" id="start">Start</button>
    <button class="ghost" id="pause">Pause</button>
    <button class="ghost" id="reset">Reset</button>
    <button class="danger" id="skip">Skip</button>
  </div>

  <div class="row">
    <label>Focus (min) <input type="number" id="focus" min="1" value="25"></label>
    <label>Short (min) <input type="number" id="short" min="1" value="5"></label>
    <label>Long (min) <input type="number" id="long" min="1" value="15"></label>
    <label>Long every <input type="number" id="every" min="2" value="4"></label>
  </div>

  <div class="stats" id="stats">Sessions today: 0 • Completed focus: 0</div>
</div>

<script>
(() => {
  const timeEl = document.getElementById('time');
  const subEl  = document.getElementById('subtitle');
  const ring   = document.getElementById('ring');
  const stats  = document.getElementById('stats');
  const btns   = { start: s('#start'), pause: s('#pause'), reset: s('#reset'), skip: s('#skip') };
  const modes  = [...document.querySelectorAll('.modes button')];

  const inputs = {
    focus: s('#focus'), short: s('#short'), long: s('#long'), every: s('#every')
  };

  const state = {
    mode: 'work',
    durations: { work: 25, short: 5, long: 15 },
    longEvery: 4,
    running: false, endAt: null, remaining: null,
    ticksToday: load('ticksToday', 0),
    completed: load('completed', 0),
    cycle: load('cycle', 0) // completed focus sessions in current cycle
  };

  // persist user prefs
  ['focus','short','long','every'].forEach(k=>{
    const key = 'pref_'+k;
    if(localStorage.getItem(key)) inputs[k].value = localStorage.getItem(key);
    inputs[k].addEventListener('change',()=>{
      localStorage.setItem(key, inputs[k].value);
      applyPrefs();
      if(!state.running) setMode(state.mode); // refresh display
    });
  });

  function s(q) { return document.querySelector(q); }
  function load(k, d) { try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } }
  function save(k, v) { localStorage.setItem(k, JSON.stringify(v)); }

  function applyPrefs(){
    state.durations.work = clamp(1, 240, +inputs.focus.value || 25);
    state.durations.short = clamp(1, 120, +inputs.short.value || 5);
    state.durations.long = clamp(1, 240, +inputs.long.value || 15);
    state.longEvery = clamp(2, 12, +inputs.every.value || 4);
  }
  function clamp(a,b,v){ return Math.max(a, Math.min(b, v)); }

  function setMode(m){
    state.mode = m;
    modes.forEach(b=>b.classList.toggle('active', b.dataset.mode === m || (m==='work' && b.dataset.mode==='work')));
    const mins = m==='work' ? state.durations.work : (m==='short'?state.durations.short:state.durations.long);
    state.remaining = mins * 60 * 1000;
    state.running = false; state.endAt = null;
    render();
  }

  function render(){
    const ms = Math.max(0, state.running ? state.endAt - Date.now() : state.remaining ?? 0);
    const t  = msToParts(ms);
    timeEl.textContent = `${pad(t.m)}:${pad(t.s)}`;
    const total = (state.mode==='work' ? state.durations.work : state.mode==='short' ? state.durations.short : state.durations.long) * 60 * 1000;
    const pct = total ? Math.round(((total - ms)/total) * 360) : 0;
    ring.style.setProperty('--p', pct);
    subEl.textContent = state.mode==='work' ? (state.running?'Focus':'Ready') : (state.mode==='short'?'Short break':'Long break');
    stats.textContent = `Sessions today: ${state.ticksToday} • Completed focus: ${state.completed}`;
  }

  let raf;
  function tick(){
    if(!state.running) return;
    const ms = state.endAt - Date.now();
    if(ms <= 0){
      state.running = false;
      notifyDone();
      if(state.mode==='work'){
        state.completed++; save('completed', state.completed);
        state.cycle = (state.cycle + 1) % state.longEvery; save('cycle', state.cycle);
        state.ticksToday++; save('ticksToday', state.ticksToday);
        // choose break length
        setMode(state.cycle===0 ? 'long' : 'short');
      } else {
        setMode('work');
      }
      // auto-start next segment
      start();
      return;
    }
    render();
    raf = requestAnimationFrame(tick);
  }

  function start(){
    if(state.running) return;
    const ms = state.remaining ?? (state.mode==='work'?state.durations.work:state.mode==='short'?state.durations.short:state.durations.long)*60*1000;
    state.endAt = Date.now() + ms;
    state.running = true;
    cancelAnimationFrame(raf);
    tick();
  }

  function pause(){
    if(!state.running) return;
    state.remaining = Math.max(0, state.endAt - Date.now());
    state.running = false;
    cancelAnimationFrame(raf);
    render();
  }

  function reset(){ state.remaining = null; setMode(state.mode); }
  function skip(){ state.running=false; cancelAnimationFrame(raf); state.remaining=0; render(); }

  function msToParts(ms){ const s = Math.ceil(ms/1000); return { m: Math.floor(s/60), s: s%60 }; }
  function pad(n){ return String(n).padStart(2,'0'); }

  function notifyDone(){
    try {
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(), g = ctx.createGain(); o.type='sine'; o.frequency.value=880;
      o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{o.stop(); ctx.close();}, 300);
    } catch {}
    if('Notification' in window){
      if(Notification.permission === 'granted'){ new Notification('Pomodoro', { body: state.mode==='work'?'Focus done!':'Break done!' }); }
      else if(Notification.permission !== 'denied'){ Notification.requestPermission(); }
    }
  }

  // UI events
  btns.start.addEventListener('click', start);
  btns.pause.addEventListener('click', pause);
  btns.reset.addEventListener('click', reset);
  btns.skip.addEventListener('click', skip);
  modes.forEach(b=>b.addEventListener('click', ()=> setMode(b.dataset.mode)));
  applyPrefs(); setMode('work'); render();

  // reset daily counter at midnight
  let lastDay = new Date().getDate();
  setInterval(()=>{ const d = new Date().getDate(); if(d!==lastDay){ lastDay=d; state.ticksToday=0; save('ticksToday',0); }}, 60000);
})();
</script>
</body>
</html>
